<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>上瀧メソッド 地元筋トレ共有アプリ ~つべこべ言わずベンチプレス~</title>
<style>
  :root {
    --border:#e5e7eb; --muted:#6b7280; --bg:#f9fafb; --card:#ffffff;
    --groupA:#ffffff; --groupB:#f6f7fb;
  }
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body { margin:0; background:var(--bg);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#111; }
  .container { max-width:960px; margin:0 auto; padding:16px; }
  header h1 { font-size:20px; margin:0 0 4px; }
  header small { color:var(--muted); }

  .panel, form { background: var(--card); border: 1px solid var(--border);
    border-radius: 14px; padding: 12px; margin: 12px 0; }

  label { display:block; margin:8px 0 4px; font-weight:600; font-size:14px; }
  input, select, textarea, button {
    width:100%; padding:12px 10px; font-size:16px; border-radius:10px; border:1px solid var(--border);
    min-height:44px;
  }
  input[type="date"]{ padding:10px; }
  textarea { resize: vertical; }

  .row { display:grid; gap:10px; grid-template-columns:1fr 1fr; }
  @media (max-width:700px){ .row { grid-template-columns:1fr; } }

  .pills { display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling: touch; padding-bottom:4px; }
  .pill { flex:0 0 auto; padding:8px 12px; border:1px solid var(--border);
    border-radius:999px; background:#fff; cursor:pointer; font-size:14px; }
  .pill.active { background:#eef2ff; border-color:#c7d2fe; }

  table { width:100%; border-collapse: collapse; display:none; }
  th, td { border-bottom: 1px solid var(--border); padding:10px; text-align:left; font-size:14px; }
 
  .list { display:grid; gap:8px; }
  .groupHeader { padding:6px 10px; font-weight:700; color:#374151; border-left:3px solid #9ca3af; background:#eef2f7; border-radius:8px; }
  .card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; }
  .cardA { background: var(--groupA); }
  .cardB { background: var(--groupB); }
  .row2 { display:flex; gap:8px; flex-wrap:wrap; font-size:13px; color:#374151; }
  .kv { display:flex; gap:4px; align-items:center; }
  .kv b { font-weight:700; }
  .ts { color:var(--muted); font-size:12px; }

  .tabs { display:flex; gap:8px; margin-bottom:8px; overflow:auto; }
  .tabBtn { flex:0 0 auto; padding:10px 14px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; }
  .tabBtn.active { background:#f3f4f6; }

  .stickyBar { position: sticky; bottom: env(safe-area-inset-bottom); background: var(--card);
    padding:12px; border:1px solid var(--border); border-radius:12px; margin-top:10px; }
  .primary { background:#111827; color:#fff; border-color:#111827; }
  .subtle { background:#fff; }

  /* --- セット行の見出し＆削除ボタン --- */
  .setRow { border:1px solid var(--border); border-radius:10px; padding:10px; margin-top:8px; }
  .setRowHeader { display:flex; align-items:center; justify-content:space-between; }
  .setBadge { font-weight:700; font-size:14px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fff; }
  .delBtn { margin-left:8px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;
    background:#fff; color:#b91c1c; font-size:14px; min-height:36px; }
  .delBtn:active { transform: translateY(1px); }
</style>

<body>
<div class="container">
<header>
  <h1>上瀧メソッド 地元筋トレ共有アプリ</h1>
  <small>~つべこべ言わずベンチプレス~</small>
</header>

<section class="panel">
  <h2 style="margin:0 0 8px;font-size:18px;">新規セットを追加</h2>
  <form id="setForm">
    <div class="row">
      <div>
        <label>日付</label>
        <input type="date" name="date" required>
      </div>
      <div>
        <label>メンバー</label>
        <select name="member" id="memberSelect" required></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>種目</label>
        <select name="exercise" id="exerciseSelect" required></select>
      </div>
      <div>
        <label>メモ（任意・セット共通）</label>
        <input type="text" name="note" placeholder="例：RPE8 / pause 2s / tempo 3-0-3">
      </div>
    </div>

    <div id="setRows"></div>

    <div class="stickyBar">
      <div class="row" style="grid-template-columns: 1fr 1fr;">
        <button type="button" id="addRowBtn" class="subtle">+ セット行を追加</button>
        <button type="submit" class="primary">登録する</button>
      </div>
      <div id="msg" style="margin-top:6px; font-size:13px; color:#374151;"></div>
    </div>
  </form>
</section>

<section class="panel">
  <h2 style="margin:0 0 8px;font-size:18px;">一覧＆PR</h2>
  <div class="tabs">
    <button type="button" class="tabBtn active" data-tab="tabMember">メンバー別</button>
    <button type="button" class="tabBtn" data-tab="tabExercise">種目別</button>
    <button type="button" class="tabBtn" data-tab="tabPR">PRボード</button>
  </div>

  <!-- メンバー別 -->
  <div id="tabMember" class="tab">
    <div class="pills" id="memberFilter"></div>

    <!-- table（タブレット以上） -->
    <table>
      <thead>
        <tr><th>日時</th><th>日付</th><th>メンバー</th><th>種目</th><th>重量</th><th>Reps</th><th>推定1RM</th><th>メモ</th></tr>
      </thead>
      <tbody id="tbodyMember"></tbody>
    </table>

    <!-- cards（スマホ） -->
    <div class="list" id="cardsMember"></div>
  </div>

  <!-- 種目別 -->
  <div id="tabExercise" class="tab" style="display:none;">
    <div class="pills" id="exerciseFilter"></div>

    <table>
      <thead>
        <tr><th>日時</th><th>日付</th><th>メンバー</th><th>種目</th><th>重量</th><th>Reps</th><th>推定1RM</th><th>メモ</th></tr>
      </thead>
      <tbody id="tbodyExercise"></tbody>
    </table>

    <div class="list" id="cardsExercise"></div>
  </div>

  <!-- PR -->
  <div id="tabPR" class="tab" style="display:none;">
    <div class="row">
      <div><label>メンバーで絞込み（任意）</label><select id="prMemberSel"><option value="">全員</option></select></div>
      <div><label>種目で絞込み（任意）</label><select id="prExSel"><option value="">全種目</option></select></div>
    </div>

    <!-- テーブル（タブレット以上） -->
    <table>
      <thead>
        <tr><th>メンバー</th><th>種目</th><th>最大W×R</th><th>セット</th><th>推定1RM</th><th>セット</th></tr>
      </thead>
      <tbody id="tbodyPR"></tbody>
    </table>

    <!-- カード（スマホ） -->
    <div class="list" id="cardsPR"></div>
  </div>
</section>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbya-qgt82eq7_E6uUCDT8xwP1xcCw3fkoJ8LzO_KTJWGjK-PLwFVvR5I5WoWhHe9qP7yA/exec';
const APP_TOKEN = 'changeme-very-long-random-token'; // Code.gsと一致

const qs = s=>document.querySelector(s);
const qsa = s=>Array.from(document.querySelectorAll(s));

/* GET */
async function apiGet(path, params={}){
  const url = new URL(API_URL);
  url.searchParams.set('path', path);
  for (const [k,v] of Object.entries(params)){ if(v!==null && v!==undefined && v!=='') url.searchParams.set(k,v); }
  const res = await fetch(url);
  return res.json();
}

/* POST：form-urlencoded（プリフライト回避） */
async function postSetForm(p){
  const params = new URLSearchParams({...p, token: APP_TOKEN});
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body: params.toString()
  });
  return res.json();
}

/* --- セット行（番号＋削除） --- */
function addSetRow(weight='', reps=''){
  const container = qs('#setRows');
  const div = document.createElement('div');
  div.className = 'setRow';
  div.innerHTML = `
    <div class="setRowHeader">
      <span class="setBadge">1セット目</span>
      <button type="button" class="delBtn" aria-label="このセット行を削除">削除</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <div>
        <label>重量(kg)</label>
        <input type="number" step="0.5" inputmode="decimal" class="weight" placeholder="例：100" value="${weight}">
      </div>
      <div>
        <label>Reps</label>
        <input type="number" min="1" inputmode="numeric" class="reps" value="${reps}">
      </div>
    </div>
  `;
  container.appendChild(div);
  renumberSetRows();
}
function renumberSetRows(){
  const rows = qsa('#setRows .setRow');
  rows.forEach((row, i)=>{
    const badge = row.querySelector('.setBadge');
    if (badge) badge.textContent = `${i+1}セット目`;
  });
}
// 削除（イベント委任）
qs('#setRows').addEventListener('click', (e)=>{
  const btn = e.target.closest('.delBtn');
  if (!btn) return;
  const row = btn.closest('.setRow');
  if (row) {
    row.remove();
    if (qsa('#setRows .setRow').length === 0) addSetRow(); // 全消し防止
    renumberSetRows();
  }
});

/* 共有UI */
function renderPills(containerSel, items, onPick, allLabel){
  const box = qs(containerSel); box.innerHTML='';
  const mk = (text, value=null)=>{
    const span = document.createElement('span');
    span.className='pill'; span.textContent=text;
    span.onclick = ()=>{ qsa(containerSel+' .pill').forEach(p=>p.classList.remove('active')); span.classList.add('active'); onPick(value); };
    return span;
  };
  const all = mk(allLabel, null); all.classList.add('active'); box.appendChild(all);
  items.forEach(it=> box.appendChild(mk(it, it)));
}

function toCardHTML(s, flipClass){
  return `
    <div class="card ${flipClass}">
      <div class="ts">${new Date(s.timestamp).toLocaleString()} / ${s.date || ''}</div>
      <div class="row2" style="margin-top:6px;">
        <span class="kv"><b>${s.member||''}</b></span>
        <span class="kv">${s.exercise||''}</span>
        <span class="kv"><b>${s.weight ?? ''}</b> kg</span>
        <span class="kv"><b>${s.reps ?? ''}</b> rep</span>
        <span class="kv">1RM: <b>${s.epley1RM ?? ''}</b></span>
      </div>
      ${s.note ? `<div style="margin-top:6px;color:#4b5563;">${s.note}</div>` : ''}
    </div>
  `;
}

/* グルーピング表示：テーブルとカード両方 */
function renderGroupedSets(tbodySel, cardsSel, sets){
  const tbody = qs(tbodySel); tbody.innerHTML='';
  const cards = qs(cardsSel); cards.innerHTML='';
  let lastKey = null, flip = false;

  const addHeader = (label)=>{
    const tr = document.createElement('tr');
    const td = document.createElement('td'); td.colSpan = 8; td.textContent = label; td.className = 'groupHeader';
    tr.appendChild(td); tbody.appendChild(tr);
    const h = document.createElement('div'); h.className='groupHeader'; h.textContent = label; cards.appendChild(h);
  };

  for (const s of sets){
    const key = `${s.date}｜${s.exercise}`;
    if (key !== lastKey){ addHeader(`${s.date} - ${s.exercise}`); flip = !flip; lastKey = key; }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(s.timestamp).toLocaleString()}</td>
      <td>${s.date||''}</td>
      <td>${s.member||''}</td>
      <td>${s.exercise||''}</td>
      <td>${s.weight ?? ''}</td>
      <td>${s.reps ?? ''}</td>
      <td>${s.epley1RM ?? ''}</td>
      <td>${(s.note||'')}</td>
    `;
    tbody.appendChild(tr);
    const flipClass = (flip ? 'cardA' : 'cardB');
    cards.insertAdjacentHTML('beforeend', toCardHTML(s, flipClass));
  }
}

function renderPRTable(rows){
  const tbody = qs('#tbodyPR'); tbody.innerHTML='';
  for (const r of rows){
    const wxrTxt = r.bestWXR ? String(r.bestWXR) : '';
    const wxrSet = r.bestWXRSet ? `${r.bestWXRSet.weight}kg × ${r.bestWXRSet.reps}rep（${r.bestWXRSet.date}）` : '';
    const eplTxt = r.bestEpley ? r.bestEpley.toFixed(1) : '';
    const eplSet = r.bestEpleySet ? `${r.bestEpleySet.weight}kg × ${r.bestEpleySet.reps}rep（${r.bestEpleySet.date}）` : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.member}</td><td>${r.exercise}</td><td>${wxrTxt}</td><td>${wxrSet}</td><td>${eplTxt}</td><td>${eplSet}</td>`;
    tbody.appendChild(tr);
  }
}
function renderPRCards(rows){
  const box = qs('#cardsPR'); box.innerHTML='';
  for (const r of rows){
    const wxrTxt = r.bestWXR ? String(r.bestWXR) : '-';
    const wxrSet = r.bestWXRSet ? `${r.bestWXRSet.weight}kg × ${r.bestWXRSet.reps}rep（${r.bestWXRSet.date}）` : '—';
    const eplTxt = r.bestEpley ? r.bestEpley.toFixed(1) : '-';
    const eplSet = r.bestEpleySet ? `${r.bestEpleySet.weight}kg × ${r.bestEpleySet.reps}rep（${r.bestEpleySet.date}）` : '—';
    box.insertAdjacentHTML('beforeend', `
      <div class="card">
        <div class="row2" style="justify-content:space-between;">
          <span><b>${r.member}</b></span><span>${r.exercise}</span>
        </div>
        <div class="row2" style="margin-top:6px;"><span>最大W×R</span><span><b>${wxrTxt}</b></span></div>
        <div class="ts">${wxrSet}</div>
        <div class="row2" style="margin-top:6px;"><span>推定1RM</span><span><b>${eplTxt}</b></span></div>
        <div class="ts">${eplSet}</div>
      </div>
    `);
  }
}

/* 初期化 */
async function init(){
  qs('input[name="date"]').value = new Date().toISOString().slice(0,10);

  const members = (await apiGet('members')).members || [];
  const exercises = (await apiGet('exercises')).exercises || [];

  const ms = qs('#memberSelect'); members.forEach(m=>{ const o=document.createElement('option'); o.value=o.textContent=m; ms.appendChild(o); });
  const es = qs('#exerciseSelect'); exercises.forEach(e=>{ const o=document.createElement('option'); o.value=o.textContent=e; es.appendChild(o); });

  const prMSel = qs('#prMemberSel'); members.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; prMSel.appendChild(o); });
  const prESel = qs('#prExSel'); exercises.forEach(e=>{ const o=document.createElement('option'); o.value=e; o.textContent=e; prESel.appendChild(o); });

  renderPills('#memberFilter', members, async (m)=>{
    const base = await apiGet('sets', m?{member:m}:{});
    const sets = base.sets || [];
    sets.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
    renderGroupedSets('#tbodyMember', '#cardsMember', sets);
  }, '全員');

  renderPills('#exerciseFilter', exercises, async (ex)=>{
    const base = await apiGet('sets', ex?{exercise:ex}:{});
    const sets = base.sets || [];
    sets.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
    renderGroupedSets('#tbodyExercise', '#cardsExercise', sets);
  }, '全種目');

  const all = (await apiGet('sets')).sets || [];
  all.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
  renderGroupedSets('#tbodyMember', '#cardsMember', all);
  renderGroupedSets('#tbodyExercise', '#cardsExercise', all);

  addSetRow(); // 最初の1行

  qsa('.tabBtn').forEach(btn=>{
    btn.onclick = ()=>{
      qsa('.tabBtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      qsa('.tab').forEach(t=>t.style.display='none');
      qs('#'+btn.dataset.tab).style.display='';
    };
  });

  await reloadPR();
}
async function reloadPR(){
  const m = qs('#prMemberSel').value;
  const e = qs('#prExSel').value;
  const data = await apiGet('prs', {member:m, exercise:e});
  renderPRTable(data.prs || []);
  renderPRCards(data.prs || []);
}

qs('#addRowBtn').onclick = ()=> addSetRow();

qs('#setForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const fd = new FormData(ev.target);
  const common = {
    date: fd.get('date'),
    member: fd.get('member'),
    exercise: fd.get('exercise'),
    note: fd.get('note') || ''
  };
  const rows = qsa('#setRows .setRow');
  if (rows.length === 0){ qs('#msg').textContent = 'セット行を追加してください'; return; }

  qs('#msg').textContent = '送信中…';

  for (const r of rows){
    const weight = r.querySelector('.weight').value;
    const reps = r.querySelector('.reps').value;
    if (!reps){ qs('#msg').textContent='Repsは必須です'; return; }
    const res = await postSetForm({...common, weight, reps});
    if (!res.ok){ qs('#msg').textContent='エラー: '+(res.error||'unknown'); return; }
  }
  qs('#msg').textContent = '登録しました！';

  qs('#setRows').innerHTML=''; addSetRow();

  const actMember = qs('#memberFilter .pill.active')?.textContent;
  const actEx     = qs('#exerciseFilter .pill.active')?.textContent;
  const mParam = (actMember && actMember!=='全員') ? {member:actMember} : {};
  const eParam = (actEx && actEx!=='全種目') ? {exercise:actEx} : {};

  const memb = await apiGet('sets', mParam);
  const setM = memb.sets||[]; setM.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
  renderGroupedSets('#tbodyMember', '#cardsMember', setM);

  const ex = await apiGet('sets', eParam);
  const setE = ex.sets||[]; setE.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
  renderGroupedSets('#tbodyExercise', '#cardsExercise', setE);

  await reloadPR();
});

init();
</script>
</body>
</html>


