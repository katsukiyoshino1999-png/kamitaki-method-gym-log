<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>上瀧メソッド 地元筋トレ共有アプリ</title>
<style>
  :root { --border:#ddd; --muted:#777; --bg:#fafafa; --groupA:#fff; --groupB:#f6f6f6; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
  header { margin-bottom: 12px; }
  form, .panel { border: 1px solid var(--border); padding: 12px; border-radius: 10px; margin-bottom: 16px; background: #fff; }
  label { display:block; margin:8px 0 4px; font-weight:600; }
  input, select, textarea, button { width:100%; padding:8px; box-sizing:border-box; }
  table { width:100%; border-collapse: collapse; }
  th, td { border-bottom: 1px solid #eee; padding: 8px; text-align:left; }
  .row { display:grid; gap:8px; grid-template-columns: repeat(2,1fr); }
  @media (max-width:680px){ .row { grid-template-columns:1fr; } }
  .pill { display:inline-block; padding:4px 10px; border:1px solid #ccc; border-radius:999px; margin:0 6px 6px 0; cursor:pointer; }
  .pill.active { background:#f2f2f2; }
  .tabs { display:flex; gap:8px; margin-bottom:8px; }
  .tabBtn { padding:8px 12px; border:1px solid #ccc; border-radius:8px; cursor:pointer; background:#fff; }
  .tabBtn.active { background:#f5f5f5; }
  .groupHeader { padding:6px 8px; font-weight:700; color:#333; border-left:3px solid #888; background:var(--bg); }
  .groupRowA td { background: var(--groupA); }
  .groupRowB td { background: var(--groupB); }
  small.muted { color: var(--muted); }
</style>
<body>
<header>
  <h1>上瀧メソッド 地元筋トレ共有アプリ</h1>
  <small class="muted">ログイン不要・URL共有のみ / 1行=1セット</small>
</header>

<section class="panel">
  <h2>新規セットを追加</h2>
  <form id="setForm">
    <div class="row">
      <div>
        <label>日付</label>
        <input type="date" name="date" required>
      </div>
      <div>
        <label>メンバー</label>
        <select name="member" id="memberSelect" required></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>種目</label>
        <select name="exercise" id="exerciseSelect" required></select>
      </div>
      <div>
        <label>メモ（任意・セット共通）</label>
        <input type="text" name="note" placeholder="例：RPE8 / pause 2s / tempo 3-0-3">
      </div>
    </div>

    <div id="setRows"></div>
    <button type="button" id="addRowBtn">+ セット行を追加</button>
    <button type="submit">登録する（行ごとに保存）</button>
    <div id="msg" style="margin-top:8px;"></div>
  </form>
</section>

<section class="panel">
  <h2>一覧＆PR</h2>
  <div class="tabs">
    <button type="button" class="tabBtn active" data-tab="tabMember">メンバー別</button>
    <button type="button" class="tabBtn" data-tab="tabExercise">種目別</button>
    <button type="button" class="tabBtn" data-tab="tabPR">PRボード</button>
  </div>

  <!-- メンバー別 -->
  <div id="tabMember" class="tab">
    <div id="memberFilter" style="margin:8px 0;"></div>
    <table>
      <thead>
        <tr><th>日時</th><th>日付</th><th>メンバー</th><th>種目</th><th>重量</th><th>Reps</th><th>推定1RM</th><th>メモ</th></tr>
      </thead>
      <tbody id="tbodyMember"></tbody>
    </table>
  </div>

  <!-- 種目別 -->
  <div id="tabExercise" class="tab" style="display:none;">
    <div id="exerciseFilter" style="margin:8px 0;"></div>
    <table>
      <thead>
        <tr><th>日時</th><th>日付</th><th>メンバー</th><th>種目</th><th>重量</th><th>Reps</th><th>推定1RM</th><th>メモ</th></tr>
      </thead>
      <tbody id="tbodyExercise"></tbody>
    </table>
  </div>

  <!-- PRボード -->
  <div id="tabPR" class="tab" style="display:none;">
    <div class="row">
      <div><label>メンバーで絞込み（任意）</label><select id="prMemberSel"><option value="">全員</option></select></div>
      <div><label>種目で絞込み（任意）</label><select id="prExSel"><option value="">全種目</option></select></div>
    </div>
    <div style="margin:8px 0;">
      <small class="muted">※ W×R=重量×回数 / Epley推定1RM = w×(1+reps/30)</small>
    </div>
    <table>
      <thead>
        <tr><th>メンバー</th><th>種目</th><th>最大W×R</th><th>セット</th><th>推定1RM</th><th>セット</th></tr>
      </thead>
      <tbody id="tbodyPR"></tbody>
    </table>
  </div>
</section>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbya-qgt82eq7_E6uUCDT8xwP1xcCw3fkoJ8LzO_KTJWGjK-PLwFVvR5I5WoWhHe9qP7yA/exec';
const APP_TOKEN = 'changeme-very-long-random-token'; // Code.gsと一致

const qs = s=>document.querySelector(s);
const qsa = s=>Array.from(document.querySelectorAll(s));

/* GET */
async function apiGet(path, params={}){
  const url = new URL(API_URL);
  url.searchParams.set('path', path);
  for (const [k,v] of Object.entries(params)){ if(v!==null && v!==undefined && v!=='') url.searchParams.set(k,v); }
  const res = await fetch(url);
  return res.json();
}

/* POST：form-urlencoded（プリフライト回避） */
async function postSetForm(p){
  const params = new URLSearchParams({...p, token: APP_TOKEN});
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body: params.toString()
  });
  return res.json();
}

/* UI helpers */
function addSetRow(weight='', reps=''){
  const div = document.createElement('div');
  div.className = 'row setRow';
  div.innerHTML = `
    <div><label>重量(kg)</label><input type="number" step="0.5" class="weight" placeholder="例：100" value="${weight}"></div>
    <div><label>Reps</label><input type="number" min="1" class="reps" value="${reps}"></div>
  `;
  qs('#setRows').appendChild(div);
}
function renderPills(containerSel, items, onPick, allLabel){
  const box = qs(containerSel); box.innerHTML='';
  const mk = (text, value=null)=>{
    const span = document.createElement('span');
    span.className='pill'; span.textContent=text;
    span.onclick = ()=>{ qsa(containerSel+' .pill').forEach(p=>p.classList.remove('active')); span.classList.add('active'); onPick(value); };
    return span;
  };
  const all = mk(allLabel, null); all.classList.add('active'); box.appendChild(all);
  items.forEach(it=> box.appendChild(mk(it, it)));
}
function renderGroupedSets(tbodySel, sets){
  const tbody = qs(tbodySel); tbody.innerHTML='';
  let lastKey = null, flip = false;
  const makeHeader = (label)=>{
    const tr = document.createElement('tr');
    const td = document.createElement('td'); td.colSpan = 8; td.textContent = label; td.className = 'groupHeader';
    tr.appendChild(td); tbody.appendChild(tr);
  };
  for (const s of sets){
    const key = `${s.date}｜${s.exercise}`;
    if (key !== lastKey){ makeHeader(`${s.date} - ${s.exercise}`); flip = !flip; lastKey = key; }
    const tr = document.createElement('tr');
    tr.className = flip ? 'groupRowA' : 'groupRowB';
    tr.innerHTML = `
      <td>${new Date(s.timestamp).toLocaleString()}</td>
      <td>${s.date||''}</td>
      <td>${s.member||''}</td>
      <td>${s.exercise||''}</td>
      <td>${s.weight ?? ''}</td>
      <td>${s.reps ?? ''}</td>
      <td>${s.epley1RM ?? ''}</td>
      <td>${(s.note||'')}</td>
    `;
    tbody.appendChild(tr);
  }
}
function renderPR(rows){
  const tbody = qs('#tbodyPR'); tbody.innerHTML='';
  for (const r of rows){
    const wxrTxt = r.bestWXR ? String(r.bestWXR) : '';
    const wxrSet = r.bestWXRSet ? `${r.bestWXRSet.weight}kg × ${r.bestWXRSet.reps}rep（${r.bestWXRSet.date}）` : '';
    const eplTxt = r.bestEpley ? r.bestEpley.toFixed(1) : '';
    const eplSet = r.bestEpleySet ? `${r.bestEpleySet.weight}kg × ${r.bestEpleySet.reps}rep（${r.bestEpleySet.date}）` : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.member}</td>
      <td>${r.exercise}</td>
      <td>${wxrTxt}</td>
      <td>${wxrSet}</td>
      <td>${eplTxt}</td>
      <td>${eplSet}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* 初期化 */
async function init(){
  qs('input[name="date"]').value = new Date().toISOString().slice(0,10);

  const members = (await apiGet('members')).members || [];
  const exercises = (await apiGet('exercises')).exercises || [];

  // 入力セレクト
  const ms = qs('#memberSelect'); members.forEach(m=>{ const o=document.createElement('option'); o.value=o.textContent=m; ms.appendChild(o); });
  const es = qs('#exerciseSelect'); exercises.forEach(e=>{ const o=document.createElement('option'); o.value=o.textContent=e; es.appendChild(o); });

  // PR 絞り込みセレクト
  const prMSel = qs('#prMemberSel'); members.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; prMSel.appendChild(o); });
  const prESel = qs('#prExSel'); exercises.forEach(e=>{ const o=document.createElement('option'); o.value=e; o.textContent=e; prESel.appendChild(o); });

  // フィルタ pills
  renderPills('#memberFilter', members, async (m)=>{
    const base = await apiGet('sets', m?{member:m}:{});
    const sets = base.sets || [];
    sets.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
    renderGroupedSets('#tbodyMember', sets);
  }, '全員');

  renderPills('#exerciseFilter', exercises, async (ex)=>{
    const base = await apiGet('sets', ex?{exercise:ex}:{});
    const sets = base.sets || [];
    sets.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
    renderGroupedSets('#tbodyExercise', sets);
  }, '全種目');

  // 初期表示（全件）
  const all = (await apiGet('sets')).sets || [];
  all.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
  renderGroupedSets('#tbodyMember', all);
  renderGroupedSets('#tbodyExercise', all);

  // セット入力 行1つ
  addSetRow();

  // タブ切替
  qsa('.tabBtn').forEach(btn=>{
    btn.onclick = ()=>{
      qsa('.tabBtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      qsa('.tab').forEach(t=>t.style.display='none');
      qs('#'+btn.dataset.tab).style.display='';
    };
  });

  // PR 初期表示
  await reloadPR();
}

async function reloadPR(){
  const m = qs('#prMemberSel').value;
  const e = qs('#prExSel').value;
  const data = await apiGet('prs', {member:m, exercise:e});
  renderPR(data.prs || []);
}

qs('#addRowBtn').onclick = ()=> addSetRow();

qs('#setForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const fd = new FormData(ev.target);
  const common = {
    date: fd.get('date'),
    member: fd.get('member'),
    exercise: fd.get('exercise'),
    note: fd.get('note') || ''
  };
  const rows = qsa('#setRows .setRow');
  if (rows.length === 0){ qs('#msg').textContent = 'セット行を追加してください'; return; }

  qs('#msg').textContent = '送信中…';

  for (const r of rows){
    const weight = r.querySelector('.weight').value;
    const reps = r.querySelector('.reps').value;
    if (!reps){ qs('#msg').textContent='Repsは必須です'; return; }
    const res = await postSetForm({...common, weight, reps});
    if (!res.ok){ qs('#msg').textContent='エラー: '+(res.error||'unknown'); return; }
  }
  qs('#msg').textContent = '登録しました！';

  // 入力リセット（1行残す）
  qs('#setRows').innerHTML=''; addSetRow();

  // 一覧を再読込（現在のフィルタに合わせる）
  const actMember = qs('#memberFilter .pill.active')?.textContent;
  const actEx     = qs('#exerciseFilter .pill.active')?.textContent;
  const mParam = (actMember && actMember!=='全員') ? {member:actMember} : {};
  const eParam = (actEx && actEx!=='全種目') ? {exercise:actEx} : {};

  const memb = await apiGet('sets', mParam);
  const setM = memb.sets||[]; setM.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
  renderGroupedSets('#tbodyMember', setM);

  const ex = await apiGet('sets', eParam);
  const setE = ex.sets||[]; setE.sort((a,b)=> (b.date.localeCompare(a.date) || a.exercise.localeCompare(b.exercise,'ja') || new Date(b.timestamp)-new Date(a.timestamp)));
  renderGroupedSets('#tbodyExercise', setE);

  // PRボード更新
  await reloadPR();
});

init();
</script>
</body>
</html>
